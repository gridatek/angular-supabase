# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a full-stack application with:
- **Backend**: Supabase (PostgreSQL, Auth, Edge Functions, Storage, Realtime)
- **Frontend**: Angular 21 with Tailwind CSS v4
- **Infrastructure**: Docker-based local development via Supabase CLI
- **CI/CD**: GitHub Actions for testing and deployment

## Development Commands

### Backend (Supabase)

Run from the **root directory**:

```bash
# Start Supabase locally (starts all services)
npm run dev

# Stop all services
npm run stop

# Reset database and re-run migrations
npm run reset

# Apply migrations locally
npm run migrate

# Apply migrations to production
npm run migrate:prod

# View service status
npm run status

# View logs
npm run logs

# Open database shell
npm run shell

# Generate TypeScript types
npm run types

# Seed test data (users & posts)
npm run seed
```

### Frontend (Angular)

Run from the **frontend/** directory:

```bash
# Start development server (http://localhost:4200)
npm start
# or
ng serve

# Build for production
npm run build
# or
ng build

# Run unit tests (Karma + Jasmine)
npm test
# or
ng test

# Run E2E tests (Playwright)
npm run e2e

# Run E2E tests with UI mode (interactive)
npm run e2e:ui

# Run E2E tests in headed mode (see browser)
npm run e2e:headed

# Debug E2E tests
npm run e2e:debug

# Show E2E test report
npm run e2e:report

# Generate new component (with inline template/styles, no tests)
ng generate component component-name

# Generate service/directive/pipe/etc.
ng generate <schematic> <name>
```

**Note**: The frontend uses Angular 21 with:
- Tailwind CSS v4 (configured in `.postcssrc.json`)
- Inline templates and styles by default (see `angular.json` schematics)
- No unit test files generated by default (configured in `angular.json`)
- E2E testing with Playwright (see `playwright.config.ts`)
- Component prefix: `app`

## Test Data

Run `npm run seed` to populate the database with:
- **3 test users** (alice, bob, carol) - Password: `password123`
  - **Alice** - Admin user (`is_admin: true`)
  - **Bob** - Regular user
  - **Carol** - Regular user
- **6 sample posts** (mix of published and draft)
- **Follow relationships** between users

**Important Notes:**
- Passwords are hashed using PostgreSQL's `crypt()` with bcrypt (blowfish)
- `pgcrypto` extension is auto-enabled in seed.sql
- All auth.users columns are properly populated (no NULL strings)
- Email confirmation is auto-set (email_confirmed_at = NOW())
- Users can login immediately after seeding
- Perfect for development and testing Edge Functions!

## Architecture Overview

### Repository Structure

```
project/
├── frontend/               # Angular 21 application
│   ├── src/
│   │   ├── app/           # Application components, services, routes
│   │   ├── index.html     # Main HTML entry point
│   │   ├── main.ts        # Bootstrap file
│   │   └── styles.css     # Global styles (Tailwind)
│   ├── public/            # Static assets
│   ├── angular.json       # Angular configuration
│   ├── tsconfig.json      # TypeScript configuration
│   └── package.json       # Frontend dependencies
│
├── supabase/              # Backend configuration
│   ├── functions/         # Edge Functions (Deno)
│   │   ├── admin-create-user/
│   │   ├── admin-list-users/
│   │   ├── admin-update-user/
│   │   ├── admin-delete-user/
│   │   ├── import_map.json
│   │   └── test-functions.ts
│   ├── migrations/        # Database migrations (00000-00006)
│   ├── seed.sql          # Seed data with proper auth schema
│   └── config.toml       # Supabase configuration
│
├── .github/workflows/     # CI/CD pipelines
├── package.json          # Root npm scripts (Supabase)
└── CLAUDE.md            # This file
```

### Core Services

All services are managed by Supabase CLI and run in Docker automatically:

- **PostgreSQL Database** (port 54322): Postgres with Supabase extensions
- **PostgREST API** (port 54321): Auto-generated REST API from database schema
- **Supabase Auth** (port 54321): Authentication service with OAuth support
- **Supabase Realtime** (port 54321): Real-time subscriptions via RLS
- **Supabase Storage** (port 54321): File storage service
- **Kong Gateway** (port 54321): API gateway routing (main entry point)
- **Inbucket** (port 54324): Email testing UI for development

### Frontend Architecture

- **Framework**: Angular 21 (standalone components, latest features)
- **Styling**: Tailwind CSS v4 with PostCSS
- **Build System**: Angular CLI with esbuild
- **Component Strategy**: Inline templates and styles (no separate files unless complex)
- **Unit Testing**: Karma + Jasmine (test generation disabled by default)
- **E2E Testing**: Playwright with Chromium
- **Routing**: Standalone routing in `app.routes.ts`

### Database Management

**Migration Files:** `supabase/migrations/` with 5-digit sequential numbering (00000, 00001, etc.)
- Existing migrations:
  - 00000_create_helper_functions.sql - Helper functions for triggers
  - 00001_create_users_table.sql - User profiles table
  - 00002_create_posts_table.sql - Posts table
  - 00003_add_user_profiles.sql - User profiles enhancements
  - 00004_add_admin_role.sql - Admin role support
  - 00005_fix_handle_new_user_trigger.sql - Error handling for user creation
  - 00006_use_auth_admin_for_seed.sql - Documentation for seed approach
- Applied via `npm run migrate` which runs `supabase db push --local`
- Production: `npm run migrate:prod` runs `supabase db push`

**Configuration:** `supabase/config.toml`
- All Supabase CLI settings
- Database version, ports, schemas
- Auth providers and settings
- Storage configuration

### Environment Configuration

All configuration is in `supabase/config.toml`. No environment files needed for local development.

For production deployment:
- Set `SUPABASE_ACCESS_TOKEN` for authentication
- Set `PROJECT_ID` for your Supabase project reference
- Run `npm run link` to link to production project

### Edge Functions

**Location:** `supabase/functions/`
- **admin-create-user** - Create users with admin privileges
- **admin-list-users** - List all users (admin only)
- **admin-update-user** - Update user profiles (admin only)
- **admin-delete-user** - Delete users (admin only)
- **import_map.json** - Deno import configuration for dependencies
- **test-functions.ts** - Test suite for Edge Functions

All Edge Functions:
- Require authentication (Bearer token)
- Check admin role via `profiles.is_admin`
- Return JSON responses with CORS headers
- Auto-served by `supabase start`

### CI/CD Workflows

**`.github/workflows/ci.yml`:** (Main CI Pipeline)
- Runs on: `ubuntu-latest`
- Tests database migrations
- Seeds test data with proper auth schema
- Waits for services to be ready after reset
- Tests Edge Functions with Deno
- Comprehensive error logging and diagnostics

**Key CI Features:**
- Health checks for auth service
- Edge Functions endpoint verification
- Robust environment variable parsing
- Auto-serves Edge Functions during tests
- Tests login with seeded users
- Validates admin permissions

**`.github/workflows/deploy.yml`:**
- Deploys migrations to production
- Manual trigger only

## Development Workflow

### Initial Setup

1. **Install Supabase CLI:**
   ```bash
   npm install -g supabase
   ```

2. **Start Backend:**
   ```bash
   # From root directory
   npm run dev
   ```

3. **Start Frontend:**
   ```bash
   # From frontend/ directory
   cd frontend
   npm install
   npm start
   ```

Access:
- **Frontend**: http://localhost:4200
- **Backend API**: http://localhost:54321
- **Supabase Studio**: http://localhost:54323
- **Email UI**: http://localhost:54324

### Working with Migrations

1. **Create new migration:**
   ```bash
   # Find next number (current highest is 00006)
   # Create: supabase/migrations/00007_description.sql
   ```

2. **Apply locally:**
   ```bash
   npm run migrate
   ```

3. **Test from scratch:**
   ```bash
   npm run reset  # Drops DB, re-runs all migrations, applies seed data
   ```

4. **Check changes:**
   ```bash
   npm run diff   # Shows SQL diff between local and migrations
   ```

5. **Deploy to production:**
   ```bash
   npm run migrate:prod
   ```

### Working with Frontend

1. **Generate new component:**
   ```bash
   cd frontend
   ng generate component features/my-feature
   ```

2. **Generate service:**
   ```bash
   ng generate service services/my-service
   ```

3. **Build for production:**
   ```bash
   npm run build
   # Output in frontend/dist/
   ```

### Testing Workflow

**Backend (Edge Functions):**
```bash
# Tests run via Deno
deno run --allow-net --allow-env supabase/functions/test-functions.ts
```

**Frontend Unit Tests:**
```bash
cd frontend
npm test  # Runs Karma + Jasmine
```

**Frontend E2E Tests (Playwright):**
```bash
cd frontend

# Run all E2E tests (headless)
npm run e2e

# Run with UI mode (recommended for development)
npm run e2e:ui

# Run in headed mode (see the browser)
npm run e2e:headed

# Debug a specific test
npm run e2e:debug

# View test results report
npm run e2e:report
```

**E2E Test Structure:**
- Tests located in `frontend/e2e/`
- Configuration in `playwright.config.ts`
- Automatically starts dev server on port 4200
- Uses Chromium by default (Firefox/WebKit available)
- Example tests demonstrate auth flow with seeded users

## Migration Best Practices

- Use 5-digit sequential numbering (00000, 00001, 00002, etc.)
- Helper functions go in 00000_create_helper_functions.sql for reusability
- Enable Row Level Security (RLS) on all tables
- Test locally with `npm run diff` before applying
- Use `npm run reset` to test migrations from scratch

## Service Access

When services are running (`npm run dev`):
- **API Gateway:** http://localhost:54321 (main entry point via Kong)
- **Supabase Studio:** http://localhost:54323 (database UI, auth, storage)
- **Database:** Check `npm run status` for connection string (port 54322)
- **Email UI (Inbucket):** http://localhost:54324
- **Edge Functions:** http://localhost:54321/functions/v1/
- **Frontend (when running):** http://localhost:4200

All backend services are accessible through port 54321 (Kong gateway)

### Connecting Frontend to Backend

In your Angular app, use these environment values:
```typescript
export const environment = {
  supabaseUrl: 'http://localhost:54321',
  supabaseKey: '<ANON_KEY from supabase status>'
};
```

Get the anon key by running `npm run status` in the root directory.

## Troubleshooting

### Login Issues

If authentication fails with "Invalid login credentials":
1. Ensure `pgcrypto` extension is enabled
2. Verify passwords are hashed with `crypt('password', gen_salt('bf'))`
3. Check that all required auth.users columns are non-NULL
4. Run `npm run seed` to recreate users with proper schema

**Required auth.users columns (must be non-NULL):**
- confirmation_token, email_change, email_change_token_new, email_change_token_current
- recovery_token, phone_change, phone_change_token, reauthentication_token

### CI/CD Issues

If CI fails:
1. **Auth service not ready** - The workflow waits 15s + 10 retries
2. **Edge Functions not responding** - Check edge-runtime container logs
3. **Environment variable parsing** - Uses case-insensitive grep + fallbacks
4. **Database reset timing** - Health checks ensure services are ready

View detailed logs in GitHub Actions for diagnostics.

### Edge Functions Issues

If Edge Functions aren't accessible:
1. Ensure Deno is installed (`deno --version`)
2. Check functions exist in `supabase/functions/`
3. Verify import_map.json is present
4. Edge Functions auto-serve with `supabase start`
5. Test endpoint: `curl http://localhost:54321/functions/v1/admin-create-user`

### Database Schema Issues

If migrations fail:
1. Check migration numbering is sequential
2. Verify helper functions in 00000_create_helper_functions.sql
3. Ensure RLS is enabled on all tables
4. Test with `npm run diff` before applying
5. Use `npm run reset` to start fresh

### Frontend Issues

**Port 4200 already in use:**
```bash
# Kill the process using port 4200
# Windows: netstat -ano | findstr :4200
# Mac/Linux: lsof -ti:4200 | xargs kill
```

**Tailwind styles not applying:**
- Check `.postcssrc.json` exists
- Verify `@tailwind` directives in `src/styles.css`
- Clear Angular cache: `rm -rf .angular/cache`

**Angular CLI not found:**
```bash
cd frontend
npm install
# Or use npx: npx ng serve
```

**Playwright tests failing:**
- Ensure dev server is running on port 4200
- Check if Chromium is installed: `npx playwright install chromium`
- For CI environments, install system dependencies: `npx playwright install-deps`
- View test traces: `npm run e2e:report` after a failed test run

## Key Conventions

### Backend
- **Migration numbering**: 5-digit sequential (00000, 00001, ...)
- **Helper functions**: Place in 00000_create_helper_functions.sql for reusability
- **RLS**: Always enable on tables, define policies explicitly
- **Edge Functions**: Use Deno, require auth, check admin role via `profiles.is_admin`

### Frontend
- **Components**: Use inline templates/styles unless complex (>50 lines)
- **Services**: Place in `src/app/services/`
- **Models/Types**: Generate from Supabase: `npm run types` (outputs to `types/database.types.ts`)
- **Routing**: Use standalone routing in `app.routes.ts`
- **Styling**: Use Tailwind utility classes, avoid custom CSS unless necessary
- **E2E Tests**: Place in `frontend/e2e/`, use descriptive test names, test user flows not implementation details
- **Test Data**: Use seeded users (alice@example.com, bob@example.com, carol@example.com) with password `password123`