# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this
repository.

## Project Overview

This is a full-stack application with:

- **Backend**: Supabase (PostgreSQL, Auth, Edge Functions, Storage, Realtime)
- **Frontend**: Angular 21 with Tailwind CSS v4
- **Infrastructure**: Docker-based local development via Supabase CLI
- **CI/CD**: GitHub Actions for testing and deployment
- **Monorepo**: npm workspaces with shared Prettier configuration
- **Git Hooks**: Husky with pre-commit formatting and commit message linting

## Development Commands

### Root (Monorepo)

Run from the **root directory**:

```bash
# Supabase Backend Commands
npm run dev                 # Start Supabase locally (all services)
npm run stop               # Stop all services
npm run reset              # Reset database and re-run migrations
npm run seed               # Seed test data (users & posts)
npm run migrate            # Apply migrations locally
npm run migrate:prod       # Apply migrations to production
npm run status             # View service status
npm run logs               # View database logs
npm run shell              # Open database shell
npm run types              # Generate TypeScript types
npm run diff               # View database diff
npm run link               # Link to production project

# Frontend Commands (via workspace)
npm run frontend:dev       # Start Angular dev server
npm run frontend:build     # Build for production
npm run frontend:test      # Run unit tests
npm run frontend:e2e       # Run E2E tests

# Code Formatting (Prettier)
npm run format             # Format all files
npm run format:check       # Check formatting without changes
```

### Frontend (Angular)

Run from the **frontend/** directory:

```bash
# Start development server (http://localhost:4200)
npm start
# or
ng serve

# Build for production
npm run build
# or
ng build

# Run unit tests (Karma + Jasmine)
npm test
# or
ng test

# Run E2E tests (Playwright)
npm run e2e

# Run E2E tests with UI mode (interactive)
npm run e2e:ui

# Run E2E tests in headed mode (see browser)
npm run e2e:headed

# Debug E2E tests
npm run e2e:debug

# Show E2E test report
npm run e2e:report

# Generate new component (with inline template/styles, no tests)
ng generate component component-name

# Generate service/directive/pipe/etc.
ng generate <schematic> <name>

# Format code
npm run format
npm run format:check
```

**Note**: The frontend uses Angular 21 with:

- Tailwind CSS v4 (configured in `.postcssrc.json`)
- Inline templates and styles by default (see `angular.json` schematics)
- No unit test files generated by default (configured in `angular.json`)
- E2E testing with Playwright (see `playwright.config.ts`)
- Component prefix: `app`
- Prettier formatting (shared config from root)

## Test Data

Run `npm run seed` to populate the database with:

- **3 test users** (alice, bob, carol) - Password: `password123`
  - **Alice** - Admin user (`is_admin: true`)
  - **Bob** - Regular user
  - **Carol** - Regular user
- **6 sample posts** (mix of published and draft)
- **Follow relationships** between users

**Important Notes:**

- Passwords are hashed using PostgreSQL's `crypt()` with bcrypt (blowfish)
- `pgcrypto` extension is auto-enabled in seed.sql
- All auth.users columns are properly populated (no NULL strings)
- Email confirmation is auto-set (email_confirmed_at = NOW())
- Users can login immediately after seeding
- Perfect for development and testing Edge Functions!

## Architecture Overview

### Repository Structure

```
project/
├── frontend/               # Angular 21 application (npm workspace)
│   ├── src/
│   │   ├── app/           # Application components, services, routes
│   │   ├── index.html     # Main HTML entry point
│   │   ├── main.ts        # Bootstrap file
│   │   └── styles.css     # Global styles (Tailwind)
│   ├── e2e/               # Playwright E2E tests
│   ├── public/            # Static assets
│   ├── angular.json       # Angular configuration
│   ├── playwright.config.ts  # Playwright configuration
│   ├── tsconfig.json      # TypeScript configuration
│   └── package.json       # Frontend dependencies
│
├── supabase/              # Backend configuration
│   ├── functions/         # Edge Functions (Deno)
│   │   ├── admin-create-user/
│   │   ├── admin-list-users/
│   │   ├── admin-update-user/
│   │   ├── admin-delete-user/
│   │   ├── import_map.json
│   │   └── test-functions.ts
│   ├── migrations/        # Database migrations (00000-00006)
│   ├── seed.sql          # Seed data with proper auth schema
│   └── config.toml       # Supabase configuration
│
├── .github/workflows/     # CI/CD pipelines
├── .husky/               # Git hooks (pre-commit, commit-msg)
├── .prettierrc.json      # Shared Prettier configuration
├── .prettierignore       # Prettier ignore patterns
├── .commitlintrc.json    # Commit message linting rules
├── package.json          # Root package.json (npm workspace)
└── CLAUDE.md            # This file
```

### Core Services

All services are managed by Supabase CLI and run in Docker automatically:

- **PostgreSQL Database** (port 54322): Postgres with Supabase extensions
- **PostgREST API** (port 54321): Auto-generated REST API from database schema
- **Supabase Auth** (port 54321): Authentication service with OAuth support
- **Supabase Realtime** (port 54321): Real-time subscriptions via RLS
- **Supabase Storage** (port 54321): File storage service
- **Kong Gateway** (port 54321): API gateway routing (main entry point)
- **Inbucket** (port 54324): Email testing UI for development

### Frontend Architecture

- **Framework**: Angular 21 (standalone components, latest features)
- **Styling**: Tailwind CSS v4 with PostCSS
- **Build System**: Angular CLI with esbuild
- **Component Strategy**: Inline templates and styles (no separate files unless complex)
- **Unit Testing**: Karma + Jasmine (test generation disabled by default)
- **E2E Testing**: Playwright with Chromium
- **Routing**: Standalone routing in `app.routes.ts`
- **State Management**: Angular Signals for reactive state
- **Authentication**: Supabase Auth with @supabase/supabase-js

### Authentication System

The frontend includes a complete authentication system integrated with Supabase Auth:

**Components** (`frontend/src/app/auth/`):

- **login/login.ts** - Login form with email/password
- **signup/signup.ts** - Signup form with password confirmation
- **forgot-password/forgot-password.ts** - Password reset request form

**Protected Routes**:

- **dashboard/dashboard.ts** - Protected dashboard displaying user info
- **guards/auth-guard.ts** - Route guard protecting authenticated routes

**Auth Service** (`frontend/src/app/services/auth.service.ts`):

- Manages authentication state using Angular signals
- Provides methods: `signIn()`, `signUp()`, `signOut()`, `resetPassword()`, `updatePassword()`
- Automatically syncs auth state with Supabase session changes
- Exposes reactive state: `authState()` with user, session, and loading status

**Configuration** (`frontend/public/config.json`):

- Runtime configuration loaded via `ConfigService` using `APP_INITIALIZER`
- File is NOT committed to Git (in `.gitignore`)
- Generated automatically in CI/CD via GitHub Actions
- For local development: Copy `config.json.example` to `config.json` and update values
- Get Supabase URL and anon key from `npm run status`

**Route Configuration** (`frontend/src/app/app.routes.ts`):

- `/login` - Public login page
- `/signup` - Public signup page
- `/forgot-password` - Public password reset page
- `/dashboard` - Protected route (requires authentication via `authGuard`)
- `/admin/users` - Admin panel (requires `authGuard` + `adminGuard`)
- `/admin/users/create` - Create user (admin only)
- `/admin/users/edit/:id` - Edit user (admin only)
- `/` - Redirects to login
- All other routes redirect to login

**E2E Tests**:

- `frontend/e2e/auth.spec.ts` - Authentication flow tests
  - Login flow validation with seeded users
  - Signup flow with new user creation
  - Password reset flow
  - Protected route access control
  - User sign-out functionality
  - Complete user journey tests
- `frontend/e2e/admin.spec.ts` - Admin panel tests
  - Admin user access and navigation
  - User list display
  - Create new users (regular and admin)
  - Edit user details
  - Delete users with confirmation
  - Non-admin access prevention

**Features**:

- Form validation with template-driven forms
- Loading states during async operations
- Error and success message handling
- Automatic redirect after login/signup
- Auth guard prevents unauthorized access
- Test-friendly with `data-testid` attributes
- Uses seeded test users (alice@example.com, password: password123)

### Admin Panel (User Management)

The frontend includes a complete admin panel for managing users, protected by admin role checking.

**Components** (`frontend/src/app/admin/`):

- **users/users.ts** - List all users with table view
- **user-create/user-create.ts** - Create new users with admin checkbox
- **user-edit/user-edit.ts** - Edit user details (email, password, username, admin role)

**Admin Service** (`frontend/src/app/services/admin.service.ts`):

- Calls Supabase Edge Functions with Bearer token authentication
- Methods: `listUsers()`, `createUser()`, `updateUser()`, `deleteUser()`
- All requests include session access token from AuthService
- Integrates with existing Deno Edge Functions in `supabase/functions/`

**Admin Guard** (`frontend/src/app/guards/admin-guard.ts`):

- Checks if user is authenticated (via `authGuard`)
- Queries `profiles.is_admin` column to verify admin role
- Redirects non-admin users to `/dashboard`
- Uses `@supabase/supabase-js` client with config from `ConfigService`

**Edge Functions Integration**:

- `admin-list-users` - Lists all users (email, created_at, last_sign_in_at)
- `admin-create-user` - Creates users with optional admin role
- `admin-update-user` - Updates user details (email, password, username, is_admin)
- `admin-delete-user` - Deletes users from auth.users and profiles

**Features**:

- Full CRUD operations for user management
- Table view with email, created date, last sign in
- Create users with optional admin role
- Edit user details with optional password update
- Delete users with confirmation dialog
- Protected routes accessible only to admin users (is_admin = true)
- Error handling with user-friendly messages
- Success notifications for operations
- Loading states during async operations
- All Edge Function calls properly authenticated

**Admin Users**:

- Alice (alice@example.com) - Admin user from seed data (is_admin = true)
- Bob and Carol - Regular users (is_admin = false)
- Only admin users can access `/admin/*` routes

### Database Management

**Migration Files:** `supabase/migrations/` with 5-digit sequential numbering (00000, 00001, etc.)

- Existing migrations:
  - 00000_create_helper_functions.sql - Helper functions for triggers
  - 00001_create_users_table.sql - User profiles table
  - 00002_create_posts_table.sql - Posts table
  - 00003_add_user_profiles.sql - User profiles enhancements
  - 00004_add_admin_role.sql - Admin role support
  - 00005_fix_handle_new_user_trigger.sql - Error handling for user creation
  - 00006_use_auth_admin_for_seed.sql - Documentation for seed approach
- Applied via `npm run migrate` which runs `supabase db push --local`
- Production: `npm run migrate:prod` runs `supabase db push`

**Configuration:** `supabase/config.toml`

- All Supabase CLI settings
- Database version, ports, schemas
- Auth providers and settings
- Storage configuration

### Environment Configuration

All configuration is in `supabase/config.toml`. No environment files needed for local development.

For production deployment:

- Set `SUPABASE_ACCESS_TOKEN` for authentication
- Set `PROJECT_ID` for your Supabase project reference
- Run `npm run link` to link to production project

### Edge Functions

**Location:** `supabase/functions/`

- **admin-create-user** - Create users with admin privileges
- **admin-list-users** - List all users (admin only)
- **admin-update-user** - Update user profiles (admin only)
- **admin-delete-user** - Delete users (admin only)
- **import_map.json** - Deno import configuration for dependencies
- **test-functions.ts** - Test suite for Edge Functions

All Edge Functions:

- Require authentication (Bearer token)
- Check admin role via `profiles.is_admin`
- Return JSON responses with CORS headers
- Auto-served by `supabase start`

### CI/CD Workflows

**`.github/workflows/ci.yml`:** (Main CI Pipeline)

- Runs on: `ubuntu-latest`
- Tests database migrations
- Seeds test data with proper auth schema
- Waits for services to be ready after reset
- Tests Edge Functions with Deno
- Runs frontend E2E tests with Playwright
- Comprehensive error logging and diagnostics

**Key CI Features:**

- Health checks for auth service
- Edge Functions endpoint verification
- Robust environment variable parsing
- Auto-serves Edge Functions during tests
- Tests login with seeded users
- Validates admin permissions
- **Automatic config.json generation** from Supabase status (injects URL and anon key)
- **Frontend E2E tests** with Playwright
- Uploads test reports and screenshots as artifacts (30-day retention)

**`.github/workflows/deploy.yml`:**

- Deploys migrations to production
- Manual trigger only

## Development Workflow

### Initial Setup

1. **Install Supabase CLI:**

   ```bash
   npm install -g supabase
   ```

2. **Start Backend:**

   ```bash
   # From root directory
   npm run dev
   ```

3. **Configure Frontend:**

   ```bash
   # Copy example config
   cd frontend
   cp public/config.json.example public/config.json

   # Get Supabase credentials
   cd ..
   npm run status

   # Update frontend/public/config.json with:
   # - url: API URL from status output
   # - anonKey: anon key from status output
   ```

4. **Start Frontend:**
   ```bash
   # From frontend/ directory
   cd frontend
   npm install
   npm start
   ```

Access:

- **Frontend**: http://localhost:4200
- **Backend API**: http://localhost:54321
- **Supabase Studio**: http://localhost:54323
- **Email UI**: http://localhost:54324

### Working with Migrations

1. **Create new migration:**

   ```bash
   # Find next number (current highest is 00006)
   # Create: supabase/migrations/00007_description.sql
   ```

2. **Apply locally:**

   ```bash
   npm run migrate
   ```

3. **Test from scratch:**

   ```bash
   npm run reset  # Drops DB, re-runs all migrations, applies seed data
   ```

4. **Check changes:**

   ```bash
   npm run diff   # Shows SQL diff between local and migrations
   ```

5. **Deploy to production:**
   ```bash
   npm run migrate:prod
   ```

### Working with Frontend

1. **Generate new component:**

   ```bash
   cd frontend
   ng generate component features/my-feature
   ```

2. **Generate service:**

   ```bash
   ng generate service services/my-service
   ```

3. **Build for production:**
   ```bash
   npm run build
   # Output in frontend/dist/
   ```

### Testing Workflow

**Backend (Edge Functions):**

```bash
# Tests run via Deno
deno run --allow-net --allow-env supabase/functions/test-functions.ts
```

**Frontend Unit Tests:**

```bash
cd frontend
npm test  # Runs Karma + Jasmine
```

**Frontend E2E Tests (Playwright):**

```bash
cd frontend

# Run all E2E tests (headless)
npm run e2e

# Run with UI mode (recommended for development)
npm run e2e:ui

# Run in headed mode (see the browser)
npm run e2e:headed

# Debug a specific test
npm run e2e:debug

# View test results report
npm run e2e:report
```

**E2E Test Structure:**

- Tests located in `frontend/e2e/`
- Configuration in `playwright.config.ts`
- Automatically starts dev server on port 4200
- Uses Chromium by default (Firefox/WebKit available)
- Example tests demonstrate auth flow with seeded users

## Migration Best Practices

- Use 5-digit sequential numbering (00000, 00001, 00002, etc.)
- Helper functions go in 00000_create_helper_functions.sql for reusability
- Enable Row Level Security (RLS) on all tables
- Test locally with `npm run diff` before applying
- Use `npm run reset` to test migrations from scratch

## Service Access

When services are running (`npm run dev`):

- **API Gateway:** http://localhost:54321 (main entry point via Kong)
- **Supabase Studio:** http://localhost:54323 (database UI, auth, storage)
- **Database:** Check `npm run status` for connection string (port 54322)
- **Email UI (Inbucket):** http://localhost:54324
- **Edge Functions:** http://localhost:54321/functions/v1/
- **Frontend (when running):** http://localhost:4200

All backend services are accessible through port 54321 (Kong gateway)

### Connecting Frontend to Backend

The frontend uses runtime configuration loaded from `frontend/public/config.json`:

1. **For Local Development:**

   ```bash
   # Copy the example file
   cd frontend
   cp public/config.json.example public/config.json

   # Get credentials from Supabase
   cd ..
   npm run status

   # Edit frontend/public/config.json with the API URL and anon key
   ```

2. **For CI/CD:**
   - The config.json is automatically generated in GitHub Actions
   - Extracts URL and anon key from `supabase status` output
   - Injected before running E2E tests

The `ConfigService` loads this configuration at app startup via `APP_INITIALIZER`.

## Troubleshooting

### Login Issues

If authentication fails with "Invalid login credentials":

1. Ensure `pgcrypto` extension is enabled
2. Verify passwords are hashed with `crypt('password', gen_salt('bf'))`
3. Check that all required auth.users columns are non-NULL
4. Run `npm run seed` to recreate users with proper schema

**Required auth.users columns (must be non-NULL):**

- confirmation_token, email_change, email_change_token_new, email_change_token_current
- recovery_token, phone_change, phone_change_token, reauthentication_token

### CI/CD Issues

If CI fails:

1. **Auth service not ready** - The workflow waits 15s + 10 retries
2. **Edge Functions not responding** - Check edge-runtime container logs
3. **Environment variable parsing** - Uses case-insensitive grep + fallbacks
4. **Database reset timing** - Health checks ensure services are ready
5. **E2E tests failing** - Download artifacts from GitHub Actions (playwright-report,
   e2e-test-results)

**Viewing E2E Test Results in CI:**

1. Go to Actions tab in GitHub
2. Click on the failed workflow run
3. Scroll to "Artifacts" section at the bottom
4. Download "playwright-report" to view HTML report locally
5. Download "e2e-test-results" for screenshots and traces

View detailed logs in GitHub Actions for diagnostics.

### Edge Functions Issues

If Edge Functions aren't accessible:

1. Ensure Deno is installed (`deno --version`)
2. Check functions exist in `supabase/functions/`
3. Verify import_map.json is present
4. Edge Functions auto-serve with `supabase start`
5. Test endpoint: `curl http://localhost:54321/functions/v1/admin-create-user`

### Database Schema Issues

If migrations fail:

1. Check migration numbering is sequential
2. Verify helper functions in 00000_create_helper_functions.sql
3. Ensure RLS is enabled on all tables
4. Test with `npm run diff` before applying
5. Use `npm run reset` to start fresh

### Frontend Issues

**Port 4200 already in use:**

```bash
# Kill the process using port 4200
# Windows: netstat -ano | findstr :4200
# Mac/Linux: lsof -ti:4200 | xargs kill
```

**Tailwind styles not applying:**

- Check `.postcssrc.json` exists
- Verify `@tailwind` directives in `src/styles.css`
- Clear Angular cache: `rm -rf .angular/cache`

**Angular CLI not found:**

```bash
cd frontend
npm install
# Or use npx: npx ng serve
```

**Playwright tests failing:**

- Ensure dev server is running on port 4200
- Check if Chromium is installed: `npx playwright install chromium`
- For CI environments, install system dependencies: `npx playwright install-deps`
- View test traces: `npm run e2e:report` after a failed test run

## Git Hooks

This project uses **Husky** for Git hooks with automatic code formatting and commit message linting.

### Pre-commit Hook

Automatically runs on `git commit`:

- Formats staged files with Prettier using `lint-staged`
- Only formats files that are staged for commit
- Runs fast (only on changed files)

### Commit Message Hook

Validates commit messages follow [Conventional Commits](https://www.conventionalcommits.org/):

**Format**: `type(scope): subject`

**Allowed types**:

- `feat` - New feature
- `fix` - Bug fix
- `docs` - Documentation changes
- `style` - Code style changes (formatting, etc.)
- `refactor` - Code refactoring
- `perf` - Performance improvements
- `test` - Adding or updating tests
- `build` - Build system changes
- `ci` - CI/CD changes
- `chore` - Other changes (dependencies, configs, etc.)
- `revert` - Revert a previous commit

**Examples**:

```bash
git commit -m "feat: add user authentication"
git commit -m "fix: resolve login redirect issue"
git commit -m "docs: update API documentation"
git commit -m "chore: update dependencies"
```

### Bypassing Hooks (Not Recommended)

If you need to bypass hooks temporarily:

```bash
git commit --no-verify -m "message"
```

## Key Conventions

### Monorepo

- **npm workspaces**: Frontend is a workspace, install dependencies from root with `npm install`
- **Prettier**: Shared configuration in `.prettierrc.json`, format with `npm run format`
- **Scripts**: Use `npm run frontend:*` from root, or run directly in `frontend/` directory
- **Dependencies**: Install shared dev dependencies at root, app-specific in workspace
- **Git Hooks**: Automatic formatting on commit, conventional commit messages enforced

### Backend

- **Migration numbering**: 5-digit sequential (00000, 00001, ...)
- **Helper functions**: Place in 00000_create_helper_functions.sql for reusability
- **RLS**: Always enable on tables, define policies explicitly
- **Edge Functions**: Use Deno, require auth, check admin role via `profiles.is_admin`

### Frontend

- **Components**: Use inline templates/styles unless complex (>50 lines)
- **Services**: Place in `src/app/services/`
- **Models/Types**: Generate from Supabase: `npm run types` (outputs to `types/database.types.ts`)
- **Routing**: Use standalone routing in `app.routes.ts`
- **Styling**: Use Tailwind utility classes, avoid custom CSS unless necessary
- **E2E Tests**: Place in `frontend/e2e/`, use descriptive test names, test user flows not
  implementation details
- **Test Data**: Use seeded users (alice@example.com, bob@example.com, carol@example.com) with
  password `password123`
- **Formatting**: Automatic via pre-commit hook, or run `npm run format` manually
- **Commits**: Follow conventional commit format (enforced by commit-msg hook)
